!function(){"use strict";var cacheBlockTitle="From your account",fetchUnpublishedCaches=function(){$("#refresh-cache").button("loading"),$("#create-gpx").button("reset"),$.ajax({url:"unpublished.php",success:function(data){if($("#select-all").prop("checked",!1),$("#fetching-unpublished-caches").hide(),$("#refresh-cache").button("reset"),!data||""===data||"object"!=typeof data)return!1;if(data&&!data.success)alert(data.message);else{$("#table-unpublished-caches").show(),$("#table-caches tbody").html("");var counter=0;$.each(data.unpublishedCaches,function(guid,title){$("#table-caches tbody").append('<tr class="'+guid+'">\n   <td>#'+ ++counter+'</td>\n   <td><input type="checkbox" name="cache" class="unpublished-geocache" value="'+guid+'" id="'+guid+'" /></td>\n   <td><label for="'+guid+'">'+title+'</label></td>\n   <td class="link"><a href="http://www.geocaching.com/seek/cache_details.aspx?guid='+guid+'" title="View on geocaching.com"><span class="glyphicon glyphicon-new-window"></span></a></td>\n   <td class="status"> </td>\n</tr>\n')}),$("#unpublishedCachesBlock h4").html(cacheBlockTitle+" ("+data.count+")"),$("#table-caches tbody").show()}},error:function(jqXHR,textStatus,errorThrown){console.error(jqXHR,textStatus,errorThrown)}})},fetchUnpublishedCachesFromGM=function(){$.ajax({url:"unpublished-gm.php",success:function(data){return data&&""!==data&&"object"==typeof data?data&&!data.success?(alert(data.message),!1):void(data.unpublishedCaches&&($("#table-unpublished-caches-gm").show(),$("#table-caches-gm tbody").html(""),$.each(data.unpublishedCaches,function(guid,title){$("#table-caches-gm tbody").append('<tr>\n   <td><input type="checkbox" name="cache-gm" class="unpublished-geocache-gm" value="'+guid+'" id="'+guid+'-gm" /></td>\n   <td><label for="'+guid+'-gm">'+title+'</label></td>\n   <td class="link"><a href="http://www.geocaching.com/seek/cache_details.aspx?guid='+guid+'" title="View on geocaching.com"><span class="glyphicon glyphicon-new-window"></span></a></td>\n</tr>\n')}))):!1},error:function(jqXHR,textStatus,errorThrown){console.error(jqXHR,textStatus,errorThrown)}})};$("#login").click(function(){var btn=$(this);if("Sign in"===$(this).text()){if(""===$("#username").val()||""===$("#password").val())return btn.button("reset"),!1;$("#username").prop("disabled",!0),$("#password").prop("disabled",!0),btn.button("loading"),$.ajax({url:"login.php",type:"POST",data:{username:$("#username").val(),password:$("#password").val()},success:function(data){return data&&""!==data&&"object"==typeof data?data&&!data.success?(btn.button("reset"),$("#username").prop("disabled",!1),$("#password").prop("disabled",!1),alert(data.message),!1):($("#username").remove(),$("#password").remove(),$("#gc-form-login").prepend('<span id="signin">Hello '+data.username+"!</span>"),btn.button("signout"),$("#unpublishedCachesBlock").show(),$("#fetching-unpublished-caches").show(),void fetchUnpublishedCaches()):!1},error:function(jqXHR,textStatus,errorThrown){console.error(jqXHR,textStatus,errorThrown)}})}else"Sign out"===$(this).text()&&($("#unpublishedCachesBlock").hide(),btn.button("loading"),$.ajax({url:"login.php",type:"POST",data:{signout:!0},success:function(data){return data&&""!==data&&"object"==typeof data?void(data&&data.success&&location.reload()):!1},error:function(jqXHR,textStatus,errorThrown){console.error(jqXHR,textStatus,errorThrown)}}))}),$("#select-all").click(function(){$(".unpublished-geocache").prop("checked",$(this).is(":checked"))}),$("#select-all-gm").click(function(){$(".unpublished-geocache-gm").prop("checked",$(this).is(":checked"))}),$("#refresh-cache").click(function(){$("#table-caches tbody").slideUp(400,fetchUnpublishedCaches)}),$("#refresh-cache-gm").click(function(){$(this).button("loading"),fetchUnpublishedCachesFromGM(),$("#select-all-gm").prop("checked",!1),$(this).button("reset")}),$("#chk_split").change(function(e){$(this).prop("checked")?$("#block_split input[type=range]").prop("disabled",!1):$("#block_split input[type=range]").prop("disabled",!0)}),$("#block_split input[type=range]").change(function(e){$("label[for=chk_split]").html("Split GPX files by "+$(this).val()+" geocaches")}),$("#create-gpx").click(function(){var list=[],create=$(this);if($("input[name=cache]:checked").each(function(){list.push(this.value)}),list.length<=0)return alert("You must choose at least one cache."),!1;$("#download-links").html(""),$("#table-caches tbody tr").removeClass("success"),$("#table-caches tbody tr").removeClass("danger"),$("#table-caches .status").html(""),create.button("loading");var count=0,getGeocache=function(guid){var jsonData={guid:guid},cacheNumber=$("tr."+guid+" td").html().substr(1);return $.ajax({url:"geocaches.php?n="+encodeURIComponent(cacheNumber),type:"POST",data:jsonData,beforeSend:function(){$("."+guid+" .status").html('<img src="loader.gif" alt="">')},success:function(data){data&&data.success?($("."+data.guid).addClass("success"),$("."+data.guid+" .status").html('<span class="glyphicon glyphicon-ok"></span>')):($("."+data.guid).addClass("danger"),$("."+data.guid+" .status").html('<span class="glyphicon glyphicon-remove" data-content="'+data.message+'"></span>'))},error:function(jqXHR,textStatus,errorThrown){console.error(jqXHR,textStatus,errorThrown)},complete:function(jqXHR,textStatus){$("#create-gpx").html("Creating... "+(++count/list.length*100).toFixed(1)+"%"),"success"!==textStatus&&console.error(jqXHR,textStatus)}})},listOfPromises=list.map(getGeocache);$.when.apply($,listOfPromises).then(function(){var gpx=[];if(listOfPromises.length>1)for(var i=0,length=listOfPromises.length;length>i;++i)arguments[i][0].success&&gpx.push(arguments[i][0].guid);else arguments[0].success&&gpx.push(arguments[0].guid);if($("tbody span").popover({trigger:"hover",animation:!1}),gpx.length>0){var jsonData={guid:gpx};$("#chk_split").prop("checked")&&(jsonData.split=$("#block_split input[type=range]").val()),$.ajax({url:"download.php",type:"POST",data:jsonData,success:function(data){data&&data.success&&$("#download-links").append(data.link)},error:function(jqXHR,textStatus,errorThrown){console.error(jqXHR,textStatus,errorThrown)}})}create.button("reset")})}),$("#create-gpx-gm").click(function(){var list=[];return $("input[name=cache-gm]:checked").each(function(){list.push(this.value)}),list.length<=0?(alert("You must choose at least one cache."),!1):($("#download-links-gm").html(""),$(this).button("loading"),list.length>0&&$.ajax({url:"download.php",type:"POST",data:{guid:list,greasemonkey:!0},success:function(data){data&&data.success&&$("#download-links-gm").append(data.link)},error:function(jqXHR,textStatus,errorThrown){console.error(jqXHR,textStatus,errorThrown)}}),void $(this).button("reset"))});var cookieRegistry=[],readCookie=function(name){for(var nameEQ=name+"=",ca=document.cookie.split(";"),i=0,length=ca.length;length>i;++i){for(var c=ca[i];" "===c.charAt(0);)c=c.substring(1,c.length);if(0===c.indexOf(nameEQ))return c.substring(nameEQ.length,c.length)}return null},listenCookieChange=function(cookieName,callback){setInterval(function(){if(cookieRegistry[cookieName]){if(readCookie(cookieName)!==cookieRegistry[cookieName])return cookieRegistry[cookieName]=readCookie(cookieName),callback()}else cookieRegistry[cookieName]=readCookie(cookieName)},1e3)};listenCookieChange("unpublished",function(){$("#refresh-cache-gm").trigger("click")}),$().ready(function(){fetchUnpublishedCachesFromGM(),"true"===logged&&$("#fetching-unpublished-caches").show(0,fetchUnpublishedCaches)})}();