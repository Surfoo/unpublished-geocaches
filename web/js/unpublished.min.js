!function(){"use strict";var fetchUnpublishedCaches=function(){$("#refresh-cache").button("loading"),$.ajax({url:"unpublished.php",success:function(data){return $("#select-all").prop("checked",!1),$("#fetching-unpublished-caches").hide(),$("#refresh-cache").button("reset"),data&&""!==data&&"object"==typeof data?(data&&!data.success?alert(data.message):($("#table-unpublished-caches").show(),$("#table-caches tbody").html(""),$.each(data.unpublishedCaches,function(guid,title){$("#table-caches tbody").append('<tr class="'+guid+'">\n'+'   <td><input type="checkbox" name="cache" class="unpublished-geocache" value="'+guid+'" id="'+guid+'" /></td>\n'+'   <td><label for="'+guid+'">'+title+"</label></td>\n"+'   <td class="status"> </td>\n'+"</tr>\n")}),$("#table-caches tbody").show()),void 0):!1}})},fetchUnpublishedCachesFromGM=function(){$.ajax({url:"unpublished-gm.php",success:function(data){return data&&""!==data&&"object"==typeof data?data&&!data.success?(alert(data.message),!1):(data.unpublishedCaches&&($("#table-unpublished-caches-gm").show(),$("#table-caches-gm tbody").html(""),$.each(data.unpublishedCaches,function(guid,title){$("#table-caches-gm tbody").append('<tr>\n   <td><input type="checkbox" name="cache-gm" class="unpublished-geocache-gm" value="'+guid+'" id="'+guid+'-gm" /></td>\n'+'   <td><label for="'+guid+'-gm">'+title+"</label></td>\n"+"</tr>\n")})),void 0):!1}})};$("#login").click(function(){var btn=$(this);if("Sign in"===$(this).text()){if(""===$("#username").val()||""===$("#password").val())return btn.button("reset"),!1;$("#username").prop("disabled",!0),$("#password").prop("disabled",!0),btn.button("loading"),$.ajax({url:"login.php",type:"POST",data:{username:$("#username").val(),password:$("#password").val()},success:function(data){return data&&""!==data&&"object"==typeof data?data&&!data.success?(btn.button("reset"),$("#username").prop("disabled",!1),$("#password").prop("disabled",!1),alert(data.message),!1):($("#username").remove(),$("#password").remove(),$("#gc-form-login").prepend('<span id="signin">Hello '+data.username+"!</span>"),btn.button("signout"),$("#unpublishedCachesBlock").show(),$("#fetching-unpublished-caches").show(),fetchUnpublishedCaches(),void 0):!1}})}else"Sign out"===$(this).text()&&($("#unpublishedCachesBlock").hide(),btn.button("loading"),$.ajax({url:"login.php",type:"POST",data:{signout:!0},success:function(data){return data&&""!==data&&"object"==typeof data?(data&&data.success&&location.reload(),void 0):!1}}))}),$("#select-all").click(function(){$(".unpublished-geocache").prop("checked",$(this).is(":checked"))}),$("#select-all-gm").click(function(){$(".unpublished-geocache-gm").prop("checked",$(this).is(":checked"))}),$("#refresh-cache").click(function(){$("#table-caches tbody").slideUp(400,fetchUnpublishedCaches)}),$("#refresh-cache-gm").click(function(){$(this).button("loading"),fetchUnpublishedCachesFromGM(),$("#select-all-gm").prop("checked",!1),$(this).button("reset")}),$("#create-gpx").click(function(){var list=[],create=$(this);if($("input[name=cache]:checked").each(function(){list.push(this.value)}),list.length<=0)return alert("You must choose at least one cache."),!1;$("#download-links").html(""),$("#table-caches tbody tr").removeClass("success"),$("#table-caches tbody tr").removeClass("danger"),$("#table-caches .status").html(""),create.button("loading");var getGeocache=function(guid){return $.ajax({url:"geocaches.php",type:"POST",data:{guid:guid},beforeSend:function(){$("."+guid+" .status").html('<img src="loader.gif" alt="">')},success:function(data){data&&data.success?($("."+data.guid).addClass("success"),$("."+data.guid+" .status").html('<span class="glyphicon glyphicon-ok"></span>')):($("."+data.guid).addClass("danger"),$("."+data.guid+" .status").html('<span class="glyphicon glyphicon-remove" data-content="'+data.message+'"></span>'))}})},listOfPromises=list.map(getGeocache);$.when.apply($,listOfPromises).then(function(){var gpx=[];if(listOfPromises.length>1)for(var i=0,length=listOfPromises.length;length>i;++i)arguments[i][0].success&&gpx.push(arguments[i][0].guid);else arguments[0].success&&gpx.push(arguments[0].guid);$("tbody span").popover({trigger:"hover",animation:!1}),gpx.length>0&&$.ajax({url:"download.php",type:"POST",data:{guid:gpx},success:function(data){data&&data.success&&($("#download-links").append(data.link),data.link_wpts&&$("#download-links").append("&nbsp;"+data.link_wpts))}}),create.button("reset")})}),$("#create-gpx-gm").click(function(){var list=[];return $("input[name=cache-gm]:checked").each(function(){list.push(this.value)}),list.length<=0?(alert("You must choose at least one cache."),!1):($("#download-links-gm").html(""),$(this).button("loading"),list.length>0&&$.ajax({url:"download.php",type:"POST",data:{guid:list,greasemonkey:!0},success:function(data){data&&data.success&&($("#download-links-gm").append(data.link),data.link_wpts&&$("#download-links-gm").append("&nbsp;"+data.link_wpts))}}),$(this).button("reset"),void 0)});var cookieRegistry=[],readCookie=function(name){for(var nameEQ=name+"=",ca=document.cookie.split(";"),i=0,length=ca.length;length>i;++i){for(var c=ca[i];" "===c.charAt(0);)c=c.substring(1,c.length);if(0===c.indexOf(nameEQ))return c.substring(nameEQ.length,c.length)}return null},listenCookieChange=function(cookieName,callback){setInterval(function(){if(cookieRegistry[cookieName]){if(readCookie(cookieName)!==cookieRegistry[cookieName])return cookieRegistry[cookieName]=readCookie(cookieName),callback()}else cookieRegistry[cookieName]=readCookie(cookieName)},1e3)};listenCookieChange("unpublished",function(){$("#refresh-cache-gm").trigger("click")}),$().ready(function(){fetchUnpublishedCachesFromGM(),"true"===logged&&$("#fetching-unpublished-caches").show(0,fetchUnpublishedCaches)})}();